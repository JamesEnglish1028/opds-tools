{% extends "base.html" %}
{% block title %}Analyze ODL Feed{% endblock %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-4">Analyze ODL Feed Format & DRM</h3>
  
  <div class="alert alert-info">
    <i class="bi bi-info-circle me-1"></i>
    <strong>What this does:</strong> Pages through an ODL feed and generates a report on publication media types (EPUB, PDF, WebPublication), DRM protection schemes (Adobe DRM, Readium LCP, No DRM), and publication types without performing validation.
  </div>

  <!-- Input Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Feed Configuration</h5>
    </div>
    <div class="card-body">
      <form method="POST" id="analyzeForm">
        <div class="mb-3">
          <label for="feed_url" class="form-label">Feed URL <span class="text-danger">*</span></label>
          <input type="url" id="feed_url" name="feed_url" class="form-control" 
                 placeholder="https://example.com/odl/catalog.json" required value="{{ feed_url }}">
          <small class="form-text text-muted">Enter the URL of the ODL feed to analyze</small>
        </div>

        <div class="row">
          <div class="col-md-4">
            <label for="max_pages" class="form-label">Max Pages (Optional)</label>
            <input type="number" id="max_pages" name="max_pages" class="form-control" 
                   placeholder="Unlimited" min="1" value="{{ max_pages or '' }}">
            <small class="form-text text-muted">Limit the number of pages to analyze</small>
          </div>
          <div class="col-md-4">
            <label for="username" class="form-label">Username (Optional)</label>
            <input type="text" id="username" name="username" class="form-control" 
                   placeholder="Basic Auth Username" value="{{ username or '' }}">
          </div>
          <div class="col-md-4">
            <label for="password" class="form-label">Password (Optional)</label>
            <input type="password" id="password" name="password" class="form-control" 
                   placeholder="Basic Auth Password" value="{{ password or '' }}">
          </div>
        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-primary" id="analyzeBtn">
            Analyze
          </button>
          <button type="submit" class="btn btn-outline-secondary ms-2" name="action" value="clear">Clear</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Progress Section (shown during analysis) -->
  <div class="card shadow-sm mb-4 d-none" id="progressCard">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Analyzing ODL Feed...</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <h6 id="currentPage">Initializing...</h6>
        <div class="progress progress-tall">
          <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated progress-bar-initial" 
               role="progressbar" aria-label="ODL analysis progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">0%</div>
        </div>
      </div>
      <div id="progressDetails" class="small text-muted">
        <div><span class="badge bg-secondary me-2">Pages:</span> <span id="pagesCount">0</span></div>
        <div><span class="badge bg-primary me-2">Publications:</span> <span id="pubsCount">0</span></div>
        <div><span class="badge bg-warning me-2">Errors:</span> <span id="errorsCount">0</span></div>
      </div>
    </div>
  </div>

  {% if results and results.get('in_progress') %}
    <div class="alert alert-info">
      <i class="bi bi-hourglass-split me-1"></i>
      <strong>Analysis in progress.</strong> The feed is still being fetched and processed.
      You can refresh this page after a minute to check for completed results.
    </div>
  {% endif %}

  {% if results and results.get('error') %}
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-circle me-1"></i>
      <strong>Error:</strong> {{ results.error }}
    </div>
  {% endif %}

  {% if results and results.get('summary') %}
    <div class="d-flex gap-2 mb-3">
      <form method="POST" action="{{ url_for('odl_analyze.analyze_odl_feed_view') }}">
        <input type="hidden" name="feed_url" value="{{ feed_url }}">
        <input type="hidden" name="max_pages" value="{{ max_pages or '' }}">
        <input type="hidden" name="username" value="{{ username }}">
        <input type="hidden" name="password" value="{{ password }}">
        <input type="hidden" name="download_json" value="1">
        <button type="submit" class="btn btn-outline-secondary btn-sm">‚¨áÔ∏è Download JSON Report</button>
      </form>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('odl_analyze.analyze_odl_feed_pdf') }}">
        üìÑ Download PDF Report
      </a>
    </div>

    <!-- Summary Card -->
    <div class="card mb-3 summary-card">
      <div class="card-header">
        <i class="bi bi-bar-chart me-1"></i> Analysis Summary
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <p class="mb-1"><strong>Total Publications:</strong></p>
            <h4>{{ results.summary.total_publications }}</h4>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Pages Analyzed:</strong></p>
            <h4>{{ results.summary.pages_analyzed }}</h4>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Unique Media Types:</strong></p>
            <h4>{{ results.summary.unique_media_types }}</h4>
          </div>
          <div class="col-md-3">
            <p class="mb-1"><strong>Unique DRM Schemes:</strong></p>
            <h4>{{ results.summary.unique_drm_schemes }}</h4>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <p class="mb-2"><strong>Publication Types</strong></p>
            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Count</th>
                    <th>Percent</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Book</td>
                    <td>{{ (results.summary.publication_type_counts or {}).get('Book', 0) }}</td>
                    <td>{{ (results.summary.publication_type_percentages or {}).get('Book', 0) }}%</td>
                  </tr>
                  <tr>
                    <td>Audiobook</td>
                    <td>{{ (results.summary.publication_type_counts or {}).get('Audiobook', 0) }}</td>
                    <td>{{ (results.summary.publication_type_percentages or {}).get('Audiobook', 0) }}%</td>
                  </tr>
                  <tr>
                    <td>Periodical</td>
                    <td>{{ (results.summary.publication_type_counts or {}).get('Periodical', 0) }}</td>
                    <td>{{ (results.summary.publication_type_percentages or {}).get('Periodical', 0) }}%</td>
                  </tr>
                  <tr>
                    <td>Other</td>
                    <td>{{ (results.summary.publication_type_counts or {}).get('Other', 0) }}</td>
                    <td>{{ (results.summary.publication_type_percentages or {}).get('Other', 0) }}%</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Media Type Distribution Card -->
    <div class="card mb-3">
      <div class="card-header bg-info text-white">
        <i class="bi bi-file-earmark me-1"></i> Media Type Distribution
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">
          <small>Shows the format types available in publications (EPUB, PDF, WebPublication, Audiobook, etc.)</small>
        </p>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Media Type</th>
              <th>Count</th>
              <th>Percentage</th>
              <th>Visual</th>
            </tr>
          </thead>
          <tbody>
            {% for item in results.media_type_stats %}
            <tr>
              <td><strong>{{ item.media_type }}</strong></td>
              <td>{{ item.count }}</td>
              <td>{{ item.percentage }}%</td>
              <td>
                <div class="progress progress-short">
                  <div class="progress-bar" role="progressbar" 
                       data-progress="{{ item.percentage }}"
                       data-valuenow="{{ item.count }}"
                       data-valuemax="{{ results.summary.total_publications }}"
                       aria-label="Media type distribution: {{ item.media_type }}"
                       aria-valuemin="0" 
                       aria-valuemax="100"
                       aria-valuenow="0">
                    {{ item.percentage }}%
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- DRM Scheme Distribution Card -->
    <div class="card mb-3">
      <div class="card-header bg-warning text-dark">
        <i class="bi bi-shield-lock me-1"></i> DRM Scheme Distribution (All Instances)
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">
          <small>Shows each DRM type instance across publications. Publications with multiple DRM types are counted multiple times.</small>
        </p>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>DRM Scheme</th>
              <th>Count</th>
              <th>Percentage</th>
              <th>Visual</th>
            </tr>
          </thead>
          <tbody>
            {% for item in results.drm_scheme_stats %}
            <tr>
              <td>
                <strong>
                  {% if "Adobe" in item.drm_scheme %}
                    <span class="badge bg-warning text-dark">{{ item.drm_scheme }}</span>
                  {% elif "LCP" in item.drm_scheme or "Readium" in item.drm_scheme %}
                    <span class="badge bg-info text-dark">{{ item.drm_scheme }}</span>
                  {% elif "No DRM" in item.drm_scheme %}
                    <span class="badge bg-success">{{ item.drm_scheme }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ item.drm_scheme }}</span>
                  {% endif %}
                </strong>
              </td>
              <td>{{ item.count }}</td>
              <td>{{ item.percentage }}%</td>
              <td>
                <div class="progress progress-short">
                  <div class="progress-bar 
                    {% if "Adobe" in item.drm_scheme %}bg-warning
                    {% elif "LCP" in item.drm_scheme or "Readium" in item.drm_scheme %}bg-info
                    {% elif "No DRM" in item.drm_scheme %}bg-success
                    {% else %}bg-secondary
                    {% endif %}" 
                    role="progressbar" 
                    data-progress="{{ item.percentage }}"
                    data-valuenow="{{ item.count }}"
                    data-valuemax="{{ results.summary.total_publications }}"
                    aria-label="DRM scheme distribution: {{ item.drm_scheme }}"
                    aria-valuemin="0" 
                    aria-valuemax="100"
                    aria-valuenow="0">
                    {{ item.percentage }}%
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- DRM Protection Combinations Card -->
    <div class="card mb-3">
      <div class="card-header card-header-gradient-drm">
        <i class="bi bi-shield-lock-fill me-1"></i> DRM Protection Combinations (By Publication)
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">
          <small>Shows publications grouped by their specific DRM combination. Publications are counted only once.</small>
        </p>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>DRM Configuration</th>
              <th>Publications</th>
              <th>Percentage</th>
              <th>Visual</th>
            </tr>
          </thead>
          <tbody>
            {% for item in results.drm_combination_stats %}
            <tr>
              <td>
                <strong>
                  {% if '&' in item.combination %}
                    <span class="badge bg-danger">
                      <i class="bi bi-exclamation-triangle me-1"></i>{{ item.combination }}
                    </span>
                    <small class="text-muted d-block mt-1">Multiple DRM schemes</small>
                  {% elif "Adobe" in item.combination %}
                    <span class="badge bg-warning text-dark">{{ item.combination }}</span>
                    <small class="text-muted d-block mt-1">Single DRM type</small>
                  {% elif "LCP" in item.combination or "Readium" in item.combination %}
                    <span class="badge bg-info text-dark">{{ item.combination }}</span>
                    <small class="text-muted d-block mt-1">Single DRM type</small>
                  {% elif "Watermark" in item.combination %}
                    <span class="badge bg-primary">{{ item.combination }}</span>
                    <small class="text-muted d-block mt-1">Single DRM type</small>
                  {% elif "No DRM" in item.combination %}
                    <span class="badge bg-success">{{ item.combination }}</span>
                    <small class="text-muted d-block mt-1">DRM-free</small>
                  {% else %}
                    <span class="badge bg-secondary">{{ item.combination }}</span>
                    <small class="text-muted d-block mt-1">Unknown protection</small>
                  {% endif %}
                </strong>
              </td>
              <td>{{ item.count }}</td>
              <td>{{ item.percentage }}%</td>
              <td>
                <div class="progress progress-short">
                  <div class="progress-bar 
                    {% if '&' in item.combination %}bg-danger
                    {% elif "Adobe" in item.combination %}bg-warning
                    {% elif "LCP" in item.combination or "Readium" in item.combination %}bg-info
                    {% elif "Watermark" in item.combination %}bg-primary
                    {% elif "No DRM" in item.combination %}bg-success
                    {% else %}bg-secondary
                    {% endif %}" 
                    role="progressbar" 
                    data-progress="{{ item.percentage }}"
                    data-valuenow="{{ item.count }}"
                    data-valuemax="{{ results.summary.total_publications }}"
                    aria-label="DRM combination: {{ item.combination }}"
                    aria-valuemin="0" 
                    aria-valuemax="100"
                    aria-valuenow="0">
                    {{ item.percentage }}%
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Format MIME Types Card -->
    <div class="card mb-3">
      <div class="card-header">
        <i class="bi bi-file-text me-1"></i> Format MIME Types (Detailed)
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">
          <small>Raw MIME type formats as specified in ODL licenses</small>
        </p>
        <div class="table-responsive">
          <table class="table table-striped table-sm">
            <thead>
              <tr>
                <th>MIME Type</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
              {% for mime_type, count in results.format_counts.items() | sort %}
              <tr>
                <td><code>{{ mime_type }}</code></td>
                <td>{{ count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Page-by-Page Details (Collapsible) -->
    <div class="card">
      <div class="card-header">
        <a class="text-decoration-none text-dark" data-bs-toggle="collapse" href="#pageDetails">
          <i class="bi bi-chevron-down me-1"></i> Page-by-Page Details
          {% if results.page_stats_truncated %}
            <span class="badge bg-warning text-dark ms-2">Showing 25 of {{ results.page_stats_total }} pages</span>
          {% endif %}
        </a>
      </div>
      <div class="collapse" id="pageDetails">
        <div class="card-body">
          {% if results.page_stats_truncated %}
            <div class="alert alert-info mb-3">
              <i class="bi bi-info-circle me-1"></i>
              Showing first 20 and last 5 pages only ({{ results.page_stats_total }} total). Download JSON for complete details.
            </div>
          {% endif %}
          {% for page in results.page_stats_display %}
            <div class="mb-3 pb-3 border-bottom">
              <h6 class="text-truncate" title="{{ page.url }}">{{ page.url }}</h6>
              {% if page.error %}
                <p class="text-danger">‚ùå Error: {{ page.error }}</p>
              {% else %}
                <p class="mb-1"><strong>Publications:</strong> {{ page.publication_count }}</p>
                <p class="mb-1"><strong>Media Types:</strong> {{ page.media_types }}</p>
                <p class="mb-1"><strong>DRM Schemes:</strong> {{ page.drm_schemes }}</p>
                <p class="mb-1"><strong>Publication Types:</strong> {{ page.publication_types }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

  {% endif %}
</div>

<script>
  const analyzeBtn = document.getElementById('analyzeBtn');

  if (analyzeBtn) {
    analyzeBtn.addEventListener('click', function (e) {
      e.preventDefault();

      const feedUrl = document.getElementById('feed_url').value;
      const maxPages = document.getElementById('max_pages').value;
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const maxPagesNum = maxPages ? parseInt(maxPages, 10) : null;

      if (!feedUrl) {
        alert('Please enter a feed URL');
        return;
      }

      // Hide previous results if any
      const resultsSection = document.querySelector('.card.mb-3');
      if (resultsSection) {
        resultsSection.style.display = 'none';
      }

      // Show progress card
      const progressCard = document.getElementById('progressCard');
      progressCard.classList.remove('d-none');

      // Disable analyze button
      this.disabled = true;

      // Reset progress
      document.getElementById('currentPage').textContent = 'Connecting to server...';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressBar').textContent = '0%';
      document.getElementById('pagesCount').textContent = '0';
      document.getElementById('pubsCount').textContent = '0';
      document.getElementById('errorsCount').textContent = '0';

      // Build URL for EventSource (must be GET)
      const params = new URLSearchParams();
      params.append('feed_url', feedUrl);
      if (maxPages) {
        params.append('max_pages', maxPages);
      }
      if (username) {
        params.append('username', username);
      }
      if (password) {
        params.append('password', password);
      }

      const streamUrl = `/analyze-odl-feed/stream?${params.toString()}`;
      const eventSource = new EventSource(streamUrl);

      let totalPages = null;
      let totalPubs = 0;
      let errors = 0;
      let completionReceived = false;

      eventSource.addEventListener('message', function (e) {
        const data = JSON.parse(e.data);

        switch (data.type) {
          case 'started':
            document.getElementById('currentPage').textContent = 'Starting ODL feed analysis...';
            break;

          case 'page_fetched':
            totalPubs += data.publications || 0;
            document.getElementById('pagesCount').textContent = data.current_page;
            document.getElementById('pubsCount').textContent = totalPubs;
            document.getElementById('currentPage').textContent = `Fetched page ${data.current_page}${maxPagesNum ? ' of ' + maxPagesNum : ''}...`;

            if (maxPagesNum) {
              const progress = Math.min(100, (data.current_page / maxPagesNum) * 100);
              document.getElementById('progressBar').style.width = progress + '%';
              document.getElementById('progressBar').textContent = Math.round(progress) + '%';
            }

            break;

          case 'page_fetch_error':
            errors++;
            document.getElementById('errorsCount').textContent = errors;
            break;

          case 'pages_fetched':
            totalPages = data.total_pages;
            document.getElementById('currentPage').textContent = `Found ${totalPages} page(s) to analyze`;
            break;

          case 'page_processing':
            const pagesProcessed = data.current_page;
            const pubsOnPage = data.publications || 0;
            totalPubs += pubsOnPage;

            const percentage = totalPages ? Math.round((pagesProcessed / totalPages) * 100) : (maxPagesNum ? Math.round((pagesProcessed / maxPagesNum) * 100) : 0);
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBar').textContent = percentage + '%';
            document.getElementById('pagesCount').textContent = pagesProcessed;
            document.getElementById('pubsCount').textContent = totalPubs;
            document.getElementById('currentPage').textContent = `Processing page ${pagesProcessed}${totalPages ? ' of ' + totalPages : ''}...`;

            break;

          case 'page_error':
            errors++;
            document.getElementById('errorsCount').textContent = errors;
            break;

          case 'complete':
            completionReceived = true;
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').classList.add('bg-success');
            document.getElementById('currentPage').innerHTML = '<strong>‚úÖ Analysis Complete!</strong>';
            eventSource.close();

            // Reload the page without resubmitting form data
            // Use history API to clear the POST and do a fresh GET load
            setTimeout(() => {
              window.history.replaceState({}, document.title, window.location.pathname);
              location.reload();
            }, 2000);
            break;

          case 'error':
            document.getElementById('currentPage').innerHTML = `<strong class="text-danger">Error: ${data.message}</strong>`;
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').classList.add('bg-danger');
            eventSource.close();
            document.getElementById('analyzeBtn').disabled = false;
            break;

          default:
            break;
        }
      });

      eventSource.onerror = function () {
        if (!completionReceived) {
          document.getElementById('currentPage').innerHTML = '<strong class="text-danger">Connection lost</strong>';
          document.getElementById('progressBar').classList.remove('progress-bar-animated');
          document.getElementById('progressBar').classList.add('bg-warning');
        }
        eventSource.close();
        document.getElementById('analyzeBtn').disabled = false;
      };
    });
  }
</script>

{% endblock %}
