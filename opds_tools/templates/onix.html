{% extends "base.html" %}

{% block title %}Upload ONIX File{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-3">
  <div class="container my-4">
    <h3 class="text-primary text-uppercase mt-4 mb-4">
      <i class="bi bi-cloud-arrow-up me-2"></i> ONIX & EPUB Utilities
    </h3>
    <hr class="mt-0 mb-2">

    <div class="row g-4">
      <!-- Left Column: Upload Form Panel -->
      <div class="col-md-12">
        <div class="card shadow-sm">
          <div class="card-header bg-primary text-white">
            <h5>
              <i class="bi bi-arrow-left-right"></i> Convert ONIX to OPDS Catalog
            </h5>
          </div>
          <div class="card-body d-flex flex-column">
            <form method="post" enctype="multipart/form-data" class="mt-3">
              <div class="mb-3">
                <label for="onix_file">ONIX File (.xml)</label>
                <input class="form-control" type="file" id="onix_file" name="onix_file" accept=".xml" required>
              </div>

              <h5 class="mt-3"><i class="bi bi-link me-2"></i> Base URLs</h5>
              <p> Used for various OPDS documents, content, and images</p>
              <div class="form-floating mb-3">
                <input class="form-control" type="url" id="base_url" name="base_url" placeholder="http://127.0.0.1:5000/uploads">
                <label for="base_url">Base URL for OPDS Links</label>
              </div>
              <div class="form-floating mb-3">
                <input class="form-control" type="url" id="acq_url" name="acq_url" placeholder="http://127.0.0.1:5000/uploads">
                <label for="acq_url">Base URL for Publication Acquisition Links</label>
              </div>
              <div class="form-floating mb-3">
                <input class="form-control" type="url" id="img_url" name="img_url" placeholder="http://127.0.0.1:5000/uploads">
                <label for="img_url">Base URL for Publication Image Links</label>
              </div>

              <div class="mb-3">
                <label class="form-label d-block">ONIX Format</label>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="onix_format" id="onixReference" value="reference" {% if onix_format != 'short' %}checked{% endif %}>
                  <label class="form-check-label" for="onixReference">Reference (long tags)</label>
                </div>
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="radio" name="onix_format" id="onixShort" value="short" {% if onix_format == 'short' %}checked{% endif %}>
                  <label class="form-check-label" for="onixShort">Short (short tags)</label>
                </div>
              </div>

              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="storeInDb" name="store_in_db" value="1">
                <label class="form-check-label" for="storeInDb">Save parsed publications to database</label>
              </div>

              <div class="mb-3">
                <label for="catalog_id" class="form-label">Assign to Catalog</label>
                <select class="form-select" name="catalog_id" id="catalog_id">
                  <option value="">-- None --</option>
                  {% for catalog in catalogs %}
                    <option value="{{ catalog.id }}">{{ catalog.title }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">Generate OPDS Catalog</button>
                <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
              </div>
            </form>

            <div style="max-height: 300px; overflow-y: auto;">
              {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                  <div class="mt-3">
                    {% for category, message in messages %}
                      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>

        {% if opds_json %}
        <!-- Modal Trigger -->
        <button type="button" class="btn btn-outline-dark mt-3" data-bs-toggle="modal" data-bs-target="#jsonModal">
          <i class="bi bi-filetype-json"></i> View OPDS JSON
        </button>

        <!-- Modal -->
        <div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="jsonModalLabel">OPDS Catalog JSON</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body" style="background-color: #f5f7f7;">
                <pre class="small">{{ pretty_json }}</pre>
              </div>
              <div class="modal-footer">
                <a href="{{ url_for('onix.download_opds_json') }}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-download"></i> Download JSON
                </a>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      </div>
    </div>
  </div>
</div>
{% block scripts %}
<script>
  function clearUploadFields() {
    document.querySelectorAll('input[type="url"]').forEach(input => input.value = '');
  }
</script>
{% endblock %}
{% endblock %}
