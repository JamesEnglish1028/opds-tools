{% extends "base.html" %}
{% block title %}Validate OPDS Feed{% endblock %}

{% block content %}
<div class="container py-4">
  <h3 class="mb-4">Validate an OPDS 2.0 Feed</h3>
  
  <div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-1"></i>
    <strong>What this does:</strong> Validates OPDS 2.0 feeds for schema compliance and publication structure. 
    Checks feeds against JSON schemas and validates publication metadata including identifiers, links, and required fields.
  </div>

  <!-- Input Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Feed Configuration</h5>
    </div>
    <div class="card-body">
      <form method="POST" id="validateForm">
        <div class="mb-3">
          <label for="feed_url" class="form-label">Feed URL <span class="text-danger">*</span></label>
          <input type="url" id="feed_url" name="feed_url" class="form-control" 
                 placeholder="https://example.com/opds/catalog.json" required value="{{ feed_url }}">
          <small class="form-text text-muted">Enter the URL of the OPDS 2.0 feed to validate</small>
        </div>
        <div class="row">
          <div class="col-md-4">
            <label for="max_pages" class="form-label">Max Pages (Optional)</label>
            <input type="number" id="max_pages" name="max_pages" class="form-control" 
                   placeholder="Unlimited" min="1" value="{{ max_pages or '' }}">
            <small class="form-text text-muted">Limit pages to validate</small>
          </div>
          <div class="col-md-4">
            <label for="username" class="form-label">Username (Optional)</label>
            <input type="text" id="username" name="username" class="form-control" 
                   placeholder="Basic Auth Username" value="{{ username or '' }}">
          </div>
          <div class="col-md-4">
            <label for="password" class="form-label">Password (Optional)</label>
            <input type="password" id="password" name="password" class="form-control" 
                   placeholder="Basic Auth Password" value="{{ password or '' }}">
          </div>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-primary" id="validateBtn">
            <i class="bi bi-check-circle me-1"></i>Validate
          </button>
          <button type="submit" class="btn btn-outline-secondary ms-2" name="action" value="clear">
            <i class="bi bi-x-circle me-1"></i>Clear
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Progress Section (shown during validation) -->
  <div class="card shadow-sm mb-4 d-none" id="progressCard">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0"><i class="bi bi-hourglass-split me-2"></i>Validating Feed...</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <h6 id="currentPage">Initializing...</h6>
        <div class="progress progress-tall">
          <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated progress-bar-initial" 
               role="progressbar" aria-label="Validation progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">0%</div>
        </div>
      </div>
      <div id="progressDetails" class="small text-muted">
        <div><span class="badge bg-secondary me-2">Pages:</span> <span id="pagesCount">0</span></div>
        <div><span class="badge bg-primary me-2">Publications:</span> <span id="pubsCount">0</span></div>
        <div><span class="badge bg-danger me-2">Errors:</span> <span id="errorsCount">0</span></div>
      </div>
      <div id="progressLog" class="mt-3 p-2 bg-light rounded progress-log">
        <!-- Progress messages will appear here -->
      </div>
    </div>
  </div>

  {% if results %}
    <div class="d-flex gap-2 mb-3 flex-wrap">
      <form method="POST" action="{{ url_for('validate.validate_feed_view') }}">
        <input type="hidden" name="feed_url" value="{{ feed_url }}">
        <input type="hidden" name="download_json" value="1">
        <button type="submit" class="btn btn-outline-secondary btn-sm">‚¨áÔ∏è Download JSON Report</button>
      </form>
      <a class="btn btn-outline-primary btn-sm" href="{{ url_for('validate.validate_feed_pdf') }}">
        üìÑ Download PDF Report
      </a>
      <a class="btn btn-outline-success btn-sm" href="{{ url_for('validate.validate_feed_excel') }}">
        üìä Download Excel Report
      </a>
    </div>

    <div class="card mb-3 summary-card">
      <div class="card-header">Validation Summary</div>
      <div class="card-body">
        <p>‚úÖ Pages validated: <strong>{{ results.summary.pages_validated }}</strong></p>
        <p>üìö Publications checked: <strong>{{ results.summary.publication_count }}</strong></p>
        <p class="text-danger">‚ùå Total errors: <strong>{{ results.summary.error_count }}</strong></p>
        <p class="text-warning">‚ö†Ô∏è Total warnings: <strong>{{ results.summary.get('warning_count', 0) }}</strong></p>
      </div>
    </div>

    {% if results.feed_errors or results.publication_errors or results.get('feed_warnings') or results.get('publication_warnings') %}
      {# Build summary of errors and warnings by page #}
      {% set error_summary = {} %}
      {% for err in results.feed_errors %}
        {% set page = err.get('page_number', 'Unknown') %}
        {% if page not in error_summary %}
          {% set _ = error_summary.update({page: {'schema_errors': 0, 'structure_errors': 0, 'publication_errors': 0, 'warnings': 0, 'publications': []}}) %}
        {% endif %}
        {% if 'Schema validation' in err.get('error', '') %}
          {% set _ = error_summary[page].update({'schema_errors': error_summary[page].schema_errors + 1}) %}
        {% else %}
          {% set _ = error_summary[page].update({'structure_errors': error_summary[page].structure_errors + 1}) %}
        {% endif %}
      {% endfor %}
      {% for warn in results.get('feed_warnings', []) %}
        {% set page = warn.get('page_number', 'Unknown') %}
        {% if page not in error_summary %}
          {% set _ = error_summary.update({page: {'schema_errors': 0, 'structure_errors': 0, 'publication_errors': 0, 'warnings': 0, 'publications': []}}) %}
        {% endif %}
        {% set _ = error_summary[page].update({'warnings': error_summary[page].warnings + 1}) %}
      {% endfor %}
      {% for err in results.publication_errors %}
        {% set page = err.get('page_number', 'Unknown') %}
        {% if page not in error_summary %}
          {% set _ = error_summary.update({page: {'schema_errors': 0, 'structure_errors': 0, 'publication_errors': 0, 'warnings': 0, 'publications': []}}) %}
        {% endif %}
        {% set _ = error_summary[page].update({'publication_errors': error_summary[page].publication_errors + 1}) %}
        {% set _ = error_summary[page].publications.append({'title': err.get('title', 'Untitled'), 'error': err.get('error', '')}) %}
      {% endfor %}
      {% for warn in results.get('publication_warnings', []) %}
        {% set page = warn.get('page_number', 'Unknown') %}
        {% if page not in error_summary %}
          {% set _ = error_summary.update({page: {'schema_errors': 0, 'structure_errors': 0, 'publication_errors': 0, 'warnings': 0, 'publications': []}}) %}
        {% endif %}
        {% set _ = error_summary[page].update({'warnings': error_summary[page].warnings + 1}) %}
      {% endfor %}

      <div class="card mb-3 border-info">
        <div class="card-header bg-info text-white">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>Validation Issues Summary by Page
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Schema Errors</th>
                  <th>Feed Structure Errors</th>
                  <th>Publication Errors</th>
                  <th>Warnings</th>
                  <th>Total</th>
                  <th>Failed Publications</th>
                </tr>
              </thead>
              <tbody>
                {% for page_num in error_summary.keys()|sort %}
                  {% set page_data = error_summary[page_num] %}
                  {% set total = page_data.schema_errors + page_data.structure_errors + page_data.publication_errors + page_data.warnings %}
                  <tr>
                    <td><strong>Page {{ page_num }}</strong></td>
                    <td>
                      {% if page_data.schema_errors > 0 %}
                        <span class="badge bg-danger">{{ page_data.schema_errors }}</span>
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if page_data.structure_errors > 0 %}
                        <span class="badge bg-danger">{{ page_data.structure_errors }}</span>
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if page_data.publication_errors > 0 %}
                        <span class="badge bg-warning text-dark">{{ page_data.publication_errors }}</span>
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if page_data.warnings > 0 %}
                        <span class="badge bg-warning">{{ page_data.warnings }}</span>
                      {% else %}
                        <span class="text-muted">0</span>
                      {% endif %}
                    </td>
                    <td><strong>{{ total }}</strong></td>
                    <td>
                      {% if page_data.publications %}
                        <details>
                          <summary>{{ page_data.publications|length }} publication(s)</summary>
                          <ul class="small mt-1 mb-0">
                            {% for pub in page_data.publications[:10] %}
                              <li>{{ pub.title }}: <code class="small">{{ pub.error[:80] }}...</code></li>
                            {% endfor %}
                            {% if page_data.publications|length > 10 %}
                              <li class="text-muted">... and {{ page_data.publications|length - 10 }} more</li>
                            {% endif %}
                          </ul>
                        </details>
                      {% else %}
                        -
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}

    {% if results.feed_errors %}
      <div class="card border-danger mb-3">
        <div class="card-header bg-danger text-white">Feed Page Errors</div>
        <div class="card-body">
          <div class="mb-0">
            {% for err in results.feed_errors %}
              <div class="mb-2">
                <span class="badge bg-secondary">Page {{ err.get('page_number', '?') }}</span>
                <strong>{{ err.get('url', '') }}</strong>: {{ err.get('error', '') }}
                {% if err.get('details') %}
                  <details class="mt-1">
                    <summary>View Details</summary>
                    <pre class="small">{{ err.details | tojson(indent=2) }}</pre>
                  </details>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}


    {% if results.publication_errors %}
      <div class="card border-warning mb-3">
        <div class="card-header bg-warning text-dark">Publication Errors</div>
        <div class="card-body">
          {% for pub in results.publication_errors %}
            <div class="mb-3 border-bottom pb-2">
              <span class="badge bg-secondary">Page {{ pub.get('page_number', '?') }}</span>
              <strong>{{ pub.get('title', 'Untitled') }}</strong>
              {% if pub.get('identifier') %} <small class="text-muted">({{ pub.identifier }})</small>{% endif %}
              <br>
              <em>From: {{ pub.get('feed_url', '') }}</em><br>
              <code class="text-danger">{{ pub.get('error', '') }}</code>
              {% if pub.get('json') %}
              <details class="mt-2">
                <summary>View Raw Publication JSON</summary>
                <pre class="pre-wrap">{{ pub.json | tojson(indent=2) }}</pre>
              </details>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if results.get('feed_warnings') %}
      <div class="card border-warning mb-3">
        <div class="card-header bg-warning text-dark">
          <i class="bi bi-exclamation-triangle me-2"></i>Feed Page Warnings
        </div>
        <div class="card-body">
          <div class="mb-0">
            {% for warn in results.feed_warnings %}
              <div class="mb-2">
                <span class="badge bg-secondary">Page {{ warn.get('page_number', '?') }}</span>
                <span class="badge bg-{{ 'info' if warn.get('severity') == 'info' else 'warning' }}">{{ warn.get('severity', 'warning').upper() }}</span>
                <strong>{{ warn.get('url', '') }}</strong>: {{ warn.get('warning', '') }}
                {% if warn.get('details') %}
                  <details class="mt-1">
                    <summary>View Details</summary>
                    <pre class="small">{{ warn.details | tojson(indent=2) }}</pre>
                  </details>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    {% endif %}

    {% if results.get('publication_warnings') %}
      <div class="card border-info">
        <div class="card-header bg-info text-white">
          <i class="bi bi-info-circle me-2"></i>Publication Warnings
        </div>
        <div class="card-body">
          {% for warn in results.publication_warnings %}
            <div class="mb-2 border-bottom pb-2">
              <span class="badge bg-secondary">Page {{ warn.get('page_number', '?') }}</span>
              <span class="badge bg-{{ 'info' if warn.get('severity') == 'info' else 'warning' }}">{{ warn.get('severity', 'warning').upper() }}</span>
              <strong>{{ warn.get('title', 'Untitled') }}</strong>
              {% if warn.get('identifier') %} <small class="text-muted">({{ warn.identifier }})</small>{% endif %}
              <br>
              <em>From: {{ warn.get('feed_url', '') }}</em><br>
              <code class="text-warning">{{ warn.get('warning', '') }}</code>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  {% endif %}
</div>

<script>
// Handle live progress updates via Server-Sent Events
document.getElementById('validateBtn').addEventListener('click', function() {
  const form = document.querySelector('#validateForm');
  const formData = new FormData(form);
  
  const feedUrl = formData.get('feed_url');
  if (!feedUrl) {
    alert('Please provide a feed URL');
    return;
  }
  
  // Hide any existing results
  const existingResults = document.querySelectorAll('.card.mb-3:not(#progressCard)');
  existingResults.forEach(card => {
    if (!card.querySelector('form')) {
      card.style.display = 'none';
    }
  });
  
  // Show progress card
  const progressCard = document.getElementById('progressCard');
  progressCard.classList.remove('d-none');
  
  // Reset progress
  document.getElementById('currentPage').textContent = 'Connecting to server...';
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('progressBar').textContent = '0%';
  document.getElementById('pagesCount').textContent = '0';
  document.getElementById('pubsCount').textContent = '0';
  document.getElementById('errorsCount').textContent = '0';
  document.getElementById('progressLog').innerHTML = '';
  
  // Add log message function
  function addLogMessage(message, type = 'info') {
    const log = document.getElementById('progressLog');
    const timestamp = new Date().toLocaleTimeString();
    const badge = type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
    log.innerHTML += `<div class="mb-1"><span class="badge bg-${badge}">${timestamp}</span> ${message}</div>`;
    log.scrollTop = log.scrollHeight;
  }
  
  addLogMessage('Establishing connection to server...');
  
  // Disable validate button
  const validateBtn = document.getElementById('validateBtn');
  validateBtn.disabled = true;
  validateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validating...';
  
  // Build URL with query parameters (EventSource only supports GET)
  const params = new URLSearchParams();
  params.append('feed_url', formData.get('feed_url') || '');
  params.append('max_pages', formData.get('max_pages') || '');
  
  const streamUrl = '{{ url_for("validate.validate_feed_stream") }}?' + params.toString();
  
  // Create EventSource for Server-Sent Events
  const eventSource = new EventSource(streamUrl);
  
  let totalPages = 0;
  let totalPubs = 0;
  let totalErrors = 0;
  const maxPages = formData.get('max_pages') ? parseInt(formData.get('max_pages')) : null;
  
  eventSource.addEventListener('message', function(e) {
    const data = JSON.parse(e.data);
    
    console.log('Received event:', data.type, data); // Debug logging
    
    switch(data.type) {
      case 'started':
        document.getElementById('currentPage').textContent = 'Starting feed validation...';
        addLogMessage(`Started validating: ${data.feed_url}`);
        break;
        
      case 'pages_fetched':
        document.getElementById('currentPage').textContent = `Fetched ${data.total_pages} pages, now validating...`;
        addLogMessage(`Fetched ${data.total_pages} pages`);
        break;
        
      case 'page_fetched':
        totalPages = data.current_page;
        totalPubs += data.publications || 0;
        document.getElementById('currentPage').textContent = `Fetching page ${data.current_page}...`;
        document.getElementById('pagesCount').textContent = totalPages;
        document.getElementById('pubsCount').textContent = totalPubs;
        addLogMessage(`Fetched page ${data.current_page} (${data.publications} publications)`);
        
        // Update progress bar if max_pages is set
        if (maxPages) {
          const progress = Math.min(100, (data.current_page / maxPages) * 100);
          document.getElementById('progressBar').style.width = progress + '%';
          document.getElementById('progressBar').textContent = Math.round(progress) + '%';
        }
        break;
        
      case 'page_validating':
        document.getElementById('currentPage').textContent = `Validating page ${data.page_number}...`;
        addLogMessage(`Validating ${data.publications} publications on page ${data.page_number}`, 'info');
        break;
        
      case 'validation_stage':
        addLogMessage(`${data.stage} - Page ${data.page_number}`, 'info');
        break;
        
      case 'validation_success':
        if (data.stage === 'Publication Validation Complete') {
          addLogMessage(`‚úÖ ${data.stage} - ${data.publications_checked} publications validated`, 'success');
        } else if (data.publications_checked) {
          addLogMessage(`‚úÖ ${data.stage} - ${data.publications_checked} publications`, 'success');
        } else if (data.publication) {
          addLogMessage(`‚úÖ ${data.stage} - "${data.publication}"`, 'success');
        } else {
          addLogMessage(`‚úÖ ${data.stage} passed`, 'success');
        }
        break;
        
      case 'validation_error':
        totalErrors++;
        document.getElementById('errorsCount').textContent = totalErrors;
        
        if (data.stage === 'Publication Validation Complete') {
          addLogMessage(`‚ö†Ô∏è ${data.stage} - ${data.errors_found} error(s) in ${data.publications_checked} publications`, 'error');
        } else if (data.publication) {
          addLogMessage(`‚ùå ${data.stage} - "${data.publication}": ${data.error}`, 'error');
        } else {
          addLogMessage(`‚ùå ${data.stage}: ${data.error}`, 'error');
        }
        break;
        
      case 'validation_warning':
        // Don't increment error count for warnings
        if (data.publication) {
          addLogMessage(`‚ö†Ô∏è WARNING - "${data.publication}": ${data.warning || data.error}`, 'warning');
        } else {
          addLogMessage(`‚ö†Ô∏è WARNING - ${data.stage}: ${data.warning || data.error}`, 'warning');
        }
        break;
        
      case 'page_fetch_error':
      case 'page_validation_error':
        totalErrors++;
        document.getElementById('errorsCount').textContent = totalErrors;
        addLogMessage(`Error on page ${data.page_number || 'unknown'}: ${data.error}`, 'error');
        break;
        
      case 'error':
        totalErrors++;
        document.getElementById('errorsCount').textContent = totalErrors;
        addLogMessage(`Error: ${data.message}`, 'error');
        
        // Check if this is a fatal error
        if (!data.page_number) {
          eventSource.close();
          document.getElementById('currentPage').textContent = 'Error occurred';
          document.getElementById('progressBar').classList.remove('progress-bar-animated', 'progress-bar-striped');
          document.getElementById('progressBar').classList.add('bg-danger');
          validateBtn.disabled = false;
          validateBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Validate';
        }
        break;
        
      case 'complete':
        console.log('Completion event received, summary:', data.summary);
        eventSource.close();
        document.getElementById('currentPage').textContent = 'Validation Complete!';
        document.getElementById('progressBar').classList.remove('progress-bar-animated', 'progress-bar-striped');
        
        // Set color based on error count
        if (data.error_count === 0) {
          document.getElementById('progressBar').classList.add('bg-success');
          addLogMessage(`‚úÖ Validation complete! No errors found.`, 'success');
        } else {
          document.getElementById('progressBar').classList.add('bg-warning');
          const feedErrors = data.feed_error_count ?? 0;
          const pubErrors = data.publication_error_count ?? 0;
          addLogMessage(`‚ö†Ô∏è Validation complete with ${data.error_count} errors (${feedErrors} feed, ${pubErrors} publication)`, 'error');
        }
        
        document.getElementById('progressBar').style.width = '100%';
        document.getElementById('progressBar').textContent = '100%';
        
        addLogMessage(`Validated ${data.summary.pages_validated} pages, ${data.summary.publication_count} publications`, 'info');
        
        // Re-enable button
        validateBtn.disabled = false;
        validateBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Validate';
        
        // Reload the page without resubmitting form data
        // Use history API to clear the POST and do a fresh GET load
        addLogMessage('Redirecting to display results...', 'info');
        setTimeout(() => {
          console.log('Reloading page now...');
          window.history.replaceState({}, document.title, window.location.pathname);
          location.reload();
        }, 2000);
        break;
    }
  });
  
  eventSource.onerror = function(err) {
    console.error('EventSource error:', err);
    eventSource.close();
    
    // Only show error if we haven't received a completion event
    if (document.getElementById('currentPage').textContent !== 'Validation Complete!') {
      addLogMessage('Connection error or stream ended unexpectedly', 'error');
      document.getElementById('currentPage').textContent = 'Connection error';
      document.getElementById('progressBar').classList.remove('progress-bar-animated', 'progress-bar-striped');
      document.getElementById('progressBar').classList.add('bg-danger');
    }
    
    validateBtn.disabled = false;
    validateBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Validate';
  };
});
</script>
{% endblock %}
